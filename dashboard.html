/* =========================================================
   NETVISION ATS â€“ STABLE MASTER PRODUCTION SCRIPT
========================================================= */

const SUPABASE_URL = "https://ftxrrgdmkpnghxilnpsk.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun",
                "Jul","Aug","Sep","Oct","Nov","Dec"];

/* ================= BASIC UTIL ================= */

function today(){
  return new Date().toISOString().split("T")[0];
}

function switchTab(id){
  document.querySelectorAll(".section").forEach(s=>{
    s.classList.remove("active");
  });
  document.getElementById(id).classList.add("active");
}

async function logout(){
  await supabase.auth.signOut();
  window.location="index.html";
}

/* ================= DAILY ================= */

async function addDaily(){
  if(!dailyName.value) return;

  await supabase.from("daily").insert([{
    entry_date: today(),
    name: dailyName.value,
    email: dailyEmail.value,
    phone: dailyPhone.value,
    requirement: dailyRequirement.value,
    client: dailyClient.value
  }]);

  dailyName.value="";
  dailyEmail.value="";
  dailyPhone.value="";
  dailyRequirement.value="";
  dailyClient.value="";

  loadAll();
}

async function loadDaily(){
  const { data } = await supabase.from("daily").select("*");
  dailyBody.innerHTML="";

  data?.forEach(r=>{
    dailyBody.innerHTML+=`
      <tr>
        <td>${r.name}</td>
        <td>${r.email||""}</td>
        <td>${r.phone||""}</td>
        <td>${r.requirement||""}</td>
        <td>${r.client||""}</td>
        <td>
          <button onclick="copyToSubmission('${r.id}')">Sub</button>
          <button onclick="deleteRecord('daily','${r.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* ================= SUBMISSION ================= */

async function copyToSubmission(id){
  const { data } = await supabase.from("daily").select("*").eq("id",id).single();

  await supabase.from("submission").insert([{
    submission_date: today(),
    name: data.name,
    email: data.email,
    phone: data.phone,
    requirement: data.requirement,
    client: data.client
  }]);

  loadAll();
}

async function loadSubmission(){
  const { data } = await supabase.from("submission").select("*");
  submissionBody.innerHTML="";

  data?.forEach(r=>{
    submissionBody.innerHTML+=`
      <tr>
        <td>${r.name}</td>
        <td>${r.client||""}</td>
        <td>
          <button onclick="copyToInterview('${r.id}')">Interview</button>
          <button onclick="deleteRecord('submission','${r.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* ================= INTERVIEW ================= */

async function copyToInterview(id){
  const { data } = await supabase.from("submission").select("*").eq("id",id).single();

  await supabase.from("interview").insert([{
    interview_scheduled_on: today(),
    name: data.name,
    client: data.client
  }]);

  loadAll();
}

async function loadInterview(){
  const { data } = await supabase.from("interview").select("*");
  interviewBody.innerHTML="";

  data?.forEach(r=>{
    interviewBody.innerHTML+=`
      <tr>
        <td>${r.name}</td>
        <td>${r.client||""}</td>
        <td>
          <button onclick="copyToPlacement('${r.id}')">Placement</button>
          <button onclick="deleteRecord('interview','${r.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* ================= PLACEMENT ================= */

async function copyToPlacement(id){
  const { data } = await supabase.from("interview").select("*").eq("id",id).single();

  await supabase.from("placement").insert([{
    placement_date: today(),
    name: data.name,
    client: data.client
  }]);

  loadAll();
}

async function loadPlacement(){
  const { data } = await supabase.from("placement").select("*");
  placementBody.innerHTML="";

  data?.forEach(r=>{
    placementBody.innerHTML+=`
      <tr>
        <td>${r.name}</td>
        <td>${r.client||""}</td>
        <td>
          <button onclick="copyToStart('${r.id}')">Start</button>
          <button onclick="deleteRecord('placement','${r.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* ================= START ================= */

async function copyToStart(id){
  const { data } = await supabase.from("placement").select("*").eq("id",id).single();

  await supabase.from("start").insert([{
    start_date: today(),
    name: data.name,
    client: data.client
  }]);

  loadAll();
}

async function loadStart(){
  const { data } = await supabase.from("start").select("*");
  startBody.innerHTML="";

  data?.forEach(r=>{
    startBody.innerHTML+=`
      <tr>
        <td>${r.name}</td>
        <td>${r.client||""}</td>
        <td>
          <button onclick="deleteRecord('start','${r.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* ================= TASKS ================= */

async function addTask(){
  if(!taskTitle.value) return;

  await supabase.from("tasks").insert([{
    title: taskTitle.value,
    status:"pending"
  }]);

  taskTitle.value="";
  loadAll();
}

async function completeTask(id){
  await supabase.from("tasks").update({status:"completed"}).eq("id",id);
  loadAll();
}

async function loadTasks(){
  const { data } = await supabase.from("tasks").select("*");
  taskBody.innerHTML="";

  data?.forEach(t=>{
    taskBody.innerHTML+=`
      <tr>
        <td>${t.title}</td>
        <td>${t.status}</td>
        <td>
          ${t.status==="pending" ? `<button onclick="completeTask('${t.id}')">Complete</button>` : ""}
          <button onclick="deleteRecord('tasks','${t.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* Reminder every 1 hour */
setInterval(async()=>{
  const { data } = await supabase.from("tasks").select("*").eq("status","pending");
  if(data && data.length>0){
    alert("You have pending tasks.");
  }
},3600000);

/* ================= MEETINGS ================= */

async function addMeeting(){
  if(!meetingTitle.value) return;

  await supabase.from("meetings").insert([{
    title: meetingTitle.value
  }]);

  meetingTitle.value="";
  loadAll();
}

async function loadMeetings(){
  const { data } = await supabase.from("meetings").select("*");
  meetingBody.innerHTML="";

  data?.forEach(m=>{
    meetingBody.innerHTML+=`
      <tr>
        <td>${m.title}</td>
        <td>
          <button onclick="deleteRecord('meetings','${m.id}')">Del</button>
        </td>
      </tr>`;
  });
}

/* ================= KPI ================= */

async function renderKPI(){
  const { data:sub } = await supabase.from("submission").select("*");
  const { data:int } = await supabase.from("interview").select("*");
  const { data:place } = await supabase.from("placement").select("*");
  const { data:start } = await supabase.from("start").select("*");

  kpiSub.innerText=sub?.length||0;
  kpiInt.innerText=int?.length||0;
  kpiPlace.innerText=place?.length||0;
  kpiStart.innerText=start?.length||0;

  monthlyBody.innerHTML="";

  for(let m=0;m<12;m++){
    const subC=sub?.filter(r=>r.submission_date && new Date(r.submission_date).getMonth()===m).length||0;
    const intC=int?.filter(r=>r.interview_scheduled_on && new Date(r.interview_scheduled_on).getMonth()===m).length||0;
    const placeC=place?.filter(r=>r.placement_date && new Date(r.placement_date).getMonth()===m).length||0;
    const startC=start?.filter(r=>r.start_date && new Date(r.start_date).getMonth()===m).length||0;

    monthlyBody.innerHTML+=`
      <tr>
        <td>${MONTHS[m]}</td>
        <td>${subC}</td>
        <td>${intC}</td>
        <td>${placeC}</td>
        <td>${startC}</td>
      </tr>`;
  }
}

/* ================= GENERIC DELETE ================= */

async function deleteRecord(table,id){
  await supabase.from(table).delete().eq("id",id);
  loadAll();
}

/* ================= MASTER LOAD ================= */

async function loadAll(){
  await loadDaily();
  await loadSubmission();
  await loadInterview();
  await loadPlacement();
  await loadStart();
  await loadTasks();
  await loadMeetings();
  await renderKPI();
}

window.onload=async function(){
  loadAll();
};